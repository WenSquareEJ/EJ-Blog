"use strict";(()=>{var e={};e.id=990,e.ids=[990],e.modules={2934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9261:e=>{e.exports=require("postcss")},3685:e=>{e.exports=require("http")},5687:e=>{e.exports=require("https")},5477:e=>{e.exports=require("punycode")},2781:e=>{e.exports=require("stream")},7310:e=>{e.exports=require("url")},9796:e=>{e.exports=require("zlib")},4203:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>x,patchFetch:()=>_,requestAsyncStorage:()=>d,routeModule:()=>m,serverHooks:()=>f,staticGenerationAsyncStorage:()=>h});var s={};r.r(s),r.d(s,{GET:()=>c,POST:()=>g});var n=r(9303),a=r(8716),o=r(670),i=r(7070),l=r(474),u=r(7364),p=r(6525);async function c(e){let t=new URL(e.url),r=Math.max(parseInt(t.searchParams.get("page")||"1",10),1),s=Math.min(Math.max(parseInt(t.searchParams.get("pageSize")||"10",10),1),50),n=(r-1)*s,a=(0,l.ZP)(),{data:o,error:u,count:p}=await a.from("posts").select(`
        id,
        title,
        content,
        content_html,
        content_json,
        image_url,
        status,
        created_at,
        published_at,
        author,
        post_tags:post_tags(
          tags:tags(id, name, slug)
        )
      `,{count:"exact"}).eq("status","approved").order("published_at",{ascending:!1}).range(n,n+s-1);if(u)return i.NextResponse.json({error:u.message},{status:500});let c=(o??[]).map(e=>{let{post_tags:t,...r}=e,s=(t??[]).map(e=>e.tags).filter(e=>!!e);return{...r,tags:s}});return i.NextResponse.json({page:r,pageSize:s,total:p??0,posts:c})}async function g(e){let t=(0,l.ZP)(),{data:r,error:s}=await t.auth.getUser();if(s||!r?.user)return i.NextResponse.json({error:"Not authenticated"},{status:401});let{title:n,content_md:a,content_html:o,content_json:c,content_text:g,tags:m=[],images:d=[]}=await e.json().catch(()=>({}));if(!n||!(a||o||g))return i.NextResponse.json({error:"Missing title or content"},{status:400});let h=g?.trim()??a?.trim()??"",f=o?.trim()??"";f?f=(0,u.bb)(f):a?f=(0,u.c8)(a):h&&(f=(0,u.c8)(h));let x=(0,p.BD)(m),_={title:n,content:(a??h)||"",content_html:f||null,content_json:c??null,author:r.user.id,status:"pending",images:d},{data:w,error:v}=await t.from("posts").insert(_).select("id, title, content, content_html, content_json, image_url, status, created_at, author").single();if(v)return i.NextResponse.json({error:v.message},{status:500});let b=[];if(w?.id){let e=await (0,p.Zl)(t,w.id,x);if(e.error)return i.NextResponse.json({error:e.error},{status:500});b=e.tags}return i.NextResponse.json({post:{...w,tags:b}},{status:201})}let m=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/posts/route",pathname:"/api/posts",filename:"route",bundlePath:"app/api/posts/route"},resolvedPagePath:"/Users/Wenyu/Documents/GitHub/EJ-Blog/app/api/posts/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:d,staticGenerationAsyncStorage:h,serverHooks:f}=m,x="/api/posts/route";function _(){return(0,o.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:h})}},7364:(e,t,r)=>{r.d(t,{AJ:()=>p,aW:()=>u,bb:()=>i,c8:()=>l});var s=r(3021),n=r.n(s),a=r(7661);a.TU.setOptions({gfm:!0,breaks:!0});let o={allowedTags:["p","br","strong","em","u","s","blockquote","ul","ol","li","h1","h2","h3","h4","h5","h6","code","pre","a","img","hr"],allowedAttributes:{a:["href","name","target","rel"],img:["src","alt","title","width","height"],"*":["class"]},allowedSchemes:["http","https","mailto"],transformTags:{a:n().simpleTransform("a",{target:"_blank",rel:"noopener noreferrer"},!0)}};function i(e){return n()(e,o)}function l(e){let t=a.TU.parse(e??"");return i("string"==typeof t?t:t.toString())}function u(e){var t;let r=e.content_html?.trim(),s=e.content?.trim(),a="";r?a=i(r):s&&(a=l(s));let o=a?(t=a,n()(t,{allowedTags:[],allowedAttributes:{}}).trim()):s?.trim()??"";return{html:a,text:o}}function p(e,t=180){let r=e.replace(/\s+/g," ").trim();return r.length<=t?r:`${r.slice(0,t).trimEnd()}â€¦`}},474:(e,t,r)=>{r.d(t,{ZP:()=>a});var s=r(1615),n=r(7721);let a=function(){return function(){let e=(0,s.cookies)();return(0,n.createServerClient)(process.env.NEXT_PUBLIC_SUPABASE_URL,process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY,{cookies:{get:t=>e.get(t)?.value,set(){},remove(){}}})}()}},6525:(e,t,r)=>{function s(e){if(!Array.isArray(e))return[];let t=new Set,r=[];for(let s of e){if("string"!=typeof s)continue;let e=s.trim().toLowerCase();if(e&&!(e.length>20)&&!t.has(e)&&(r.push(e),t.add(e),r.length>=12))break}return r}async function n(e,t,r){if(!t||0===r.length)return{tags:[],error:null};let s=r.map(e=>{let t=e.trim().toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"").slice(0,50);return t?{name:e,slug:t}:null}).filter(e=>!!e);if(0===s.length)return{tags:[],error:null};let{data:n,error:a}=await e.from("tags").upsert(s,{onConflict:"slug"}).select("id, name, slug");if(a)return{tags:[],error:a.message};let o=(n??[]).map(e=>e.id?{id:e.id,name:e.name,slug:e.slug}:null).filter(e=>!!e);if(0===o.length)return{tags:[],error:null};let i=o.map(e=>({post_id:t,tag_id:e.id})),{error:l}=await e.from("post_tags").upsert(i,{onConflict:"post_id,tag_id"});return l?{tags:o,error:l.message}:{tags:o,error:null}}r.d(t,{BD:()=>s,Zl:()=>n})}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[948,326,738,702,972,937],()=>r(4203));module.exports=s})();